<script>
(function(){
  const convPk = '{{ conversation.pk }}';
  const messagesEl = document.getElementById('messages');
  const form = document.getElementById('message-form');
  let lastTimestamp = null;

  function updateLastTimestamp() {
    const messages = messagesEl.querySelectorAll('.message');
    if (messages.length > 0) {
      lastTimestamp = messages[messages.length - 1].dataset.sentAt;
    }
  }
  
  function appendMessage(m) {
  const div = document.createElement('div');
  div.className = 'message ' + (m.sender_id == {{ request.user.id }} ? 'me' : 'them');
  div.dataset.id = m.id;
  div.dataset.sentAt = m.sent_at;

  // header
  const header = document.createElement('small');
  const strong = document.createElement('strong');
  strong.textContent = m.sender;
  const em = document.createElement('em');
  em.textContent = ' ' + (new Date(m.sent_at)).toLocaleString();
  header.appendChild(strong);
  header.appendChild(em);

    const body = document.createElement('div');
    body.classList.add('message-content');
m.content.split('\n').forEach((line, index, arr) => {
body.appendChild(document.createTextNode(line));
    if (index < arr.length - 1) body.appendChild(document.createElement('br'));
  });

    div.appendChild(header);
    div.appendChild(body);

  if (m.sender_id == {{ request.user.id }}) {
    const actions = document.createElement('div');
    actions.classList.add('message-actions');

    const editBtn = document.createElement('button');
    editBtn.type = 'button';
    editBtn.className = 'btn btn-sm btn-primary edit-btn me-1';
    editBtn.textContent = 'Edit';

    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'btn btn-sm btn-danger delete-btn';
    deleteBtn.textContent = 'Delete';

    actions.appendChild(editBtn);
    actions.appendChild(deleteBtn);

    div.appendChild(actions);
  }
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  lastTimestamp = m.sent_at;
}



  // In your script tag, replace the old poll function with this one
async function poll() {
    let url = `{% url 'conversation_messages_json' conversation.pk %}`;
    if (lastTimestamp) {
        url += '?after=' + encodeURIComponent(lastTimestamp);
    }
    try {
      const resp = await fetch(url, {credentials: 'same-origin'});
      if (!resp.ok) return;
      const data = await resp.json();
        
      let mostRecentTimestamp = lastTimestamp;

      if (data.messages && data.messages.length) {
        data.messages.forEach(m => {
                const existingMessage = document.querySelector(`.message[data-id='${m.id}']`);
                if (existingMessage) {
                    const contentEl = existingMessage.querySelector('.message-content');
                    if (contentEl && contentEl.innerHTML.trim() !== m.content.trim().replace(/\n/g, '<br>')) {
                        contentEl.innerHTML = m.content.replace(/\n/g, '<br>');
                    }
                } else {
                    appendMessage(m);
                }
                
                if (!mostRecentTimestamp || m.sent_at > mostRecentTimestamp) {
                    mostRecentTimestamp = m.sent_at;
                }
            });
        }
        
        if (data.all_ids) {
            const allOnScreen = [...messagesEl.querySelectorAll('.message')];
            const receivedIds = new Set(data.all_ids.map(String)); // Ensure IDs are strings for comparison
            
            allOnScreen.forEach(msgDiv => {
                const msgId = msgDiv.dataset.id;
                if (!receivedIds.has(msgId)) {
                    msgDiv.remove();
                }
            });
        }
        
        if (mostRecentTimestamp && mostRecentTimestamp > lastTimestamp) {
            lastTimestamp = mostRecentTimestamp;
        }

    } catch (e) {
        console.error(e);
    }
}

  document.addEventListener('DOMContentLoaded', () => {
    updateLastTimestamp();
    setInterval(poll, 3000);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const fd = new FormData(form);
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    const resp = await fetch(form.action, {
      method: 'POST',
      body: fd,
      credentials: 'same-origin',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    sendBtn.disabled = false;
    if (resp.ok) {
      const json = await resp.json();
      appendMessage({
        id: json.id,
        sender: json.sender,
        sender_id: {{ request.user.id }},
        content: json.content,
        sent_at: json.sent_at
      });
      const ta = form.querySelector('textarea');
      if (ta) { ta.value = ''; }
      lastTimestamp = json.sent_at;
    } else {
      const json = await resp.json();
      alert(json.error || 'Failed to send message.');
    }
  });
  messagesEl.addEventListener('click', async function(e) {
  const msgDiv = e.target.closest('.message');
  if (!msgDiv) return;
  const msgId = msgDiv.dataset.id;

  // Get CSRF token for delete only
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  // --- Edit message (reuse send form CSRF) ---
if (e.target.classList.contains('edit-btn')) {
  // find the content element even if the class is missing on older messages
  let contentEl =
    msgDiv.querySelector('.message-content') ||
    msgDiv.querySelector('small + div') ||   // first div after <small>
    msgDiv.querySelector('div');             // final fallback

  if (!contentEl) return;

  const currentContent = contentEl.innerText; // preserves line breaks
  const newContent = prompt("Edit your message:", currentContent);
  if (!newContent || newContent.trim() === "") return;

  const csrfToken = document.querySelector('#message-form [name=csrfmiddlewaretoken]').value;

  const fd = new FormData();
  fd.append('content', newContent.trim());
  fd.append('csrfmiddlewaretoken', csrfToken);

  const resp = await fetch(`/messages/${msgId}/update/`, {
    method: 'POST',
    body: fd,
    credentials: 'same-origin',
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  });

  if (resp.ok) {
    const data = await resp.json();

    contentEl.innerHTML = '';
    data.content.split('\n').forEach((line, i, arr) => {
      contentEl.appendChild(document.createTextNode(line));
      if (i < arr.length - 1) contentEl.appendChild(document.createElement('br'));
    });
  } else {
    const err = await resp.json().catch(() => ({}));
    alert(err.error || 'Failed to update message.');
  }
}

  // --- Delete message (get CSRF from cookie) ---
  if (e.target.classList.contains('delete-btn')) {
    if (confirm("Are you sure you want to delete this message?")) {
      const fd = new FormData();
      fd.append('csrfmiddlewaretoken', getCookie('csrftoken'));

      const resp = await fetch(`/messages/${msgId}/delete/`, {
        method: 'POST',
        body: fd,
        credentials: 'same-origin',
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      });
      if (resp.ok) {
        msgDiv.remove();
      } else {
        const err = await resp.json().catch(() => ({}));
        alert(err.error || 'Failed to delete message.');
      }
    }
  }
});

})();
</script>
