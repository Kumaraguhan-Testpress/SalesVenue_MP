{% extends "base.html" %}
{% load widget_tweaks %}
{% block content %}
<div class="container">
  <h3>Conversation about: <a href="{{ conversation.ad.get_absolute_url }}">{{ conversation.ad.title }}</a></h3>
  <p>
    You: {{ request.user.username }} |
    Other: {{ other_user.username }}
  </p>

  <div id="messages" style="border:1px solid #ddd; padding:10px; max-height:400px; overflow:auto;">
    {% for m in messages %}
  <div class="message {% if m.sender == request.user %}me{% else %}them{% endif %}"
      data-id="{{ m.pk }}"
      data-sent-at="{{ m.sent_at|date:'c' }}">
   <small><strong>{{ m.sender.username }}</strong> <em>{{ m.sent_at|date:"M d, Y H:i" }}</em></small>
   <div>{{ m.content|linebreaksbr }}</div>
   </div>
  <hr />
{% empty %}
<p>No messages yet. Start the conversation!</p>
{% endfor %}
  </div>

  <form id="message-form" method="post" action="{% url 'send_message' conversation.pk %}">
    {% csrf_token %}
    <div class="form-group">
        {{ form.content.errors }}
        {{ form.content|add_class:"form-control"|attr:"rows:2"|attr:"placeholder:Write your message..." }}
    </div>
    <button id="send-btn" class="btn btn-primary" type="submit">Send</button>
  </form>
</div>

<script>
(function(){
  const convPk = '{{ conversation.pk }}';
  const messagesEl = document.getElementById('messages');
  const form = document.getElementById('message-form');
  let lastTimestamp = null;

  function updateLastTimestamp() {
  const messages = messagesEl.querySelectorAll('.message');
  if (messages.length > 0) {
    lastTimestamp = messages[messages.length - 1].dataset.sentAt;
  }
}
  
  function appendMessage(m) {
    const div = document.createElement('div');
    div.className = 'message ' + (m.sender_id == {{ request.user.id }} ? 'me' : 'them');
    div.dataset.id = m.id;
    div.dataset.sentAt = m.sent_at;

    const header = document.createElement('small');

    const strong = document.createElement('strong');
    strong.textContent = m.sender;

    const em = document.createElement('em');
    em.textContent = ' ' + (new Date(m.sent_at)).toLocaleString();

    header.appendChild(strong);
    header.appendChild(em);

    const body = document.createElement('div');
    m.content.split('\n').forEach((line, index, arr) => {
        body.appendChild(document.createTextNode(line));
        if (index < arr.length - 1) body.appendChild(document.createElement('br'));
    });

    div.appendChild(header);
    div.appendChild(body);
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    lastTimestamp = m.sent_at;
}


  async function poll() {
    let url = `{% url 'conversation_messages_json' conversation.pk %}`;
    if (lastTimestamp) {
      url += '?after=' + encodeURIComponent(lastTimestamp);
    }
    try {
      const resp = await fetch(url, {credentials: 'same-origin'});
      if (!resp.ok) return;
      const data = await resp.json();
      if (data.messages && data.messages.length) {
        data.messages.forEach(m => appendMessage(m));
      }
    } catch (e) { console.error(e); }
  }

  document.addEventListener('DOMContentLoaded', (event) => {
    updateLastTimestamp();
    setInterval(poll, 3000);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const fd = new FormData(form);
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    const resp = await fetch(form.action, {
      method: 'POST',
      body: fd,
      credentials: 'same-origin',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    sendBtn.disabled = false;
    if (resp.ok) {
      const json = await resp.json();
      appendMessage({
        id: json.id,
        sender: json.sender,
        sender_id: {{ request.user.id }},
        content: json.content,
        sent_at: json.sent_at
      });
      const ta = form.querySelector('textarea');
      if (ta) { ta.value = ''; }
      lastTimestamp = json.sent_at;
    } else {
      const json = await resp.json();
      alert(json.error || 'Failed to send message.');
    }
  });
})();
</script>

{% endblock %}
